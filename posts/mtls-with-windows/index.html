<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="How to configure mTLS using Windows certificate store"><title>Mutual TLS (mTLS) with Windows certificate store</title>
<link rel=canonical href=https://victoronsoftware.com/posts/mtls-with-windows/><link rel=stylesheet href=/scss/style.min.d8118f156935b64eca93aca758476adca858d2c47354971654d9bd2933a0e45f.css><meta property='og:title' content="Mutual TLS (mTLS) with Windows certificate store"><meta property='og:description' content="How to configure mTLS using Windows certificate store"><meta property='og:url' content='https://victoronsoftware.com/posts/mtls-with-windows/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='TLS'><meta property='article:tag' content='Windows'><meta property='article:tag' content='CyberSecurity'><meta property='article:published_time' content='2024-03-06T00:00:00+00:00'><meta property='article:modified_time' content='2024-03-06T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/mtls-with-windows/mtls-edge.png'><meta name=twitter:title content="Mutual TLS (mTLS) with Windows certificate store"><meta name=twitter:description content="How to configure mTLS using Windows certificate store"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/mtls-with-windows/mtls-edge.png'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu02a35fbedf562a954847f1a0edade347_219789_300x0_resize_box_3.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=social-menu><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202" xmlns="http://www.w3.org/2000/svg"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/mtls-with-windows/><img src=/posts/mtls-with-windows/mtls-edge_hu1c5448f514f25a5b4cbc44c26f1cdd9f_40356_800x0_resize_box_3.png srcset="/posts/mtls-with-windows/mtls-edge_hu1c5448f514f25a5b4cbc44c26f1cdd9f_40356_800x0_resize_box_3.png 800w, /posts/mtls-with-windows/mtls-edge_hu1c5448f514f25a5b4cbc44c26f1cdd9f_40356_1600x0_resize_box_3.png 1600w" width=800 height=386 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with Windows certificate store"></a></div><div class=article-details><header class=article-category><a href=/categories/mtls/>mTLS</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/mtls-with-windows/>Mutual TLS (mTLS) with Windows certificate store</a></h2><h3 class=article-subtitle>How to configure mTLS using Windows certificate store</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 06, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p><em>This article is part of a series on <a class=link href=/categories/mtls>mTLS</a>. Check out the previous articles:</em></p><ul><li><a class=link href=../mtls-hello-world>mTLS Hello World</a></li><li><a class=link href=../mtls-with-apple-keychain>mTLS with macOS keychain</a></li><li><a class=link href=../mtls-go-client>mTLS Go client</a></li><li><a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a></li><li><a class=link href=../mtls-go-client-using-apple-keychain>mTLS Go client using macOS keychain</a></li></ul><h2 id=why-use-windows-certificate-store>Why use Windows certificate store?</h2><p>In our previous articles, we introduced mTLS and demonstrated how to use mTLS client certificates and keys. Keeping the mTLS client private key on the filesystem is insecure and not recommended. In the <a class=link href=../mtls-go-client-using-apple-keychain>mTLS Go client using macOS keychain</a>, we demonstrated achieving greater mTLS security with macOS keychain. In this article, we start exploring how to achieve the same level of protection with Windows certificate store.</p><p>The Windows certificate store is a secure location to store certificates and keys. Many applications, such as Edge and Powershell use it. The Windows certificate store is an excellent place to store mTLS client certificates and keys.</p><p>The Windows certificate stores have two types:</p><ul><li>User certificate store: Certificates and keys are stored for the current user, local to a user account.</li><li>Local machine certificate store: Certificates and keys are stored for all users on the computer.</li></ul><p>We will store our client mTLS certificate in the user certificate store and the other certificates in the local machine certificate store.</p><h2 id=generating-mtls-certificates-and-keys>Generating mTLS certificates and keys</h2><p>We will use the following Powershell script to generate the mTLS certificates and keys. <a class=link href=https://www.openssl.org/ target=_blank rel=noopener>OpenSSL</a> must be installed on your computer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>New-Item -ItemType Directory -Force certs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Private keys for CAs</span>
</span></span><span style=display:flex><span>openssl genrsa -out certs/server-ca.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>openssl genrsa -out certs/client-ca.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate CA certificates</span>
</span></span><span style=display:flex><span>openssl req -new -x509 -nodes -days <span style=color:#ae81ff>1000</span> -key certs/server-ca.key -out certs/server-ca.crt -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testServerCA&#34;</span>
</span></span><span style=display:flex><span>openssl req -new -x509 -nodes -days <span style=color:#ae81ff>1000</span> -key certs/client-ca.key -out certs/client-ca.crt -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testClientCA&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate a certificate signing request</span>
</span></span><span style=display:flex><span>openssl req -newkey rsa<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>2048</span> -nodes -keyout certs/server.key -out certs/server.req -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testServerTLS&#34;</span>
</span></span><span style=display:flex><span>openssl req -newkey rsa<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>2048</span> -nodes -keyout certs/client.key -out certs/client.req -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testClientTLS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Have the CA sign the certificate requests and output the certificates.</span>
</span></span><span style=display:flex><span>openssl x509 -req -in certs/server.req -days <span style=color:#ae81ff>398</span> -CA certs/server-ca.crt -CAkey certs/server-ca.key -set_serial <span style=color:#ae81ff>01</span> -out certs/server.crt -extfile localhost.ext
</span></span><span style=display:flex><span>openssl x509 -req -in certs/client.req -days <span style=color:#ae81ff>398</span> -CA certs/client-ca.crt -CAkey certs/client-ca.key -set_serial <span style=color:#ae81ff>01</span> -out certs/client.crt
</span></span><span style=display:flex><span><span style=color:#75715e># Create PFX file for importing to certificate store</span>
</span></span><span style=display:flex><span>openssl pkcs12 -export -out certs\client.pfx -inkey certs\client.key -in certs\client.crt -passout pass<span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Clean up</span>
</span></span><span style=display:flex><span>Remove-Item certs/server.req
</span></span><span style=display:flex><span>Remove-Item certs/client.req
</span></span></code></pre></div><p>The maximum validity period for a TLS certificate is 398 days.</p><p>The <code>localhost.ext</code> file is used to specify the subject alternative name (SAN) for the server certificate. The <code>localhost.ext</code> file contains the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>[alt_names]
</span></span><span style=display:flex><span>DNS.1 = localhost
</span></span><span style=display:flex><span>DNS.2 = myhost
</span></span></code></pre></div><p>We can access the server using either <code>localhost</code> or <code>myhost</code> names.</p><p>The above script generates the following files:</p><ul><li><code>certs/server-ca.crt</code>: Server CA certificate</li><li><code>certs/server-ca.key</code>: Server CA private key</li><li><code>certs/client-ca.crt</code>: Client CA certificate</li><li><code>certs/client-ca.key</code>: Client CA private key</li><li><code>certs/server.crt</code>: Server certificate</li><li><code>certs/server.key</code>: Server private key</li><li><code>certs/client.crt</code>: Client certificate</li><li><code>certs/client.key</code>: Client private key</li><li><code>certs/client.pfx</code>: Client certificate and private key in PFX format, needed for importing into the Windows certificate store</li></ul><h2 id=importing-the-client-certificate-and-key-into-the-windows-certificate-store>Importing the client certificate and key into the Windows certificate store</h2><p>We will import the client certificate and key into the user certificate store using the following powershell script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Import the server CA</span>
</span></span><span style=display:flex><span>Import-Certificate -FilePath <span style=color:#e6db74>&#34;certs\server-ca.crt&#34;</span> -CertStoreLocation Cert<span style=color:#960050;background-color:#1e0010>:</span>\LocalMachine\Root
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client CA so that client TLS certificates can be verified</span>
</span></span><span style=display:flex><span>Import-Certificate -FilePath <span style=color:#e6db74>&#34;certs\client-ca.crt&#34;</span> -CertStoreLocation Cert<span style=color:#960050;background-color:#1e0010>:</span>\LocalMachine\Root
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client TLS certificate and key</span>
</span></span><span style=display:flex><span>Import-PfxCertificate -FilePath <span style=color:#e6db74>&#34;certs\client.pfx&#34;</span> -CertStoreLocation Cert<span style=color:#960050;background-color:#1e0010>:</span>\CurrentUser\My
</span></span></code></pre></div><p>The command result should be similar to the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>   PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\Root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Thumbprint                                Subject
</span></span><span style=display:flex><span>----------                                -------
</span></span><span style=display:flex><span>0A31BF3C48A3D98A91A2F63B5BD286818311A707  CN=testServerCA, OU=Your Unit, O=Your Organization, L=Austin, S=Texas, C=US
</span></span><span style=display:flex><span>7F7E5612F3A90B9EB246762358251F98911A9D1A  CN=testClientCA, OU=Your Unit, O=Your Organization, L=Austin, S=Texas, C=US
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   PSParentPath: Microsoft.PowerShell.Security\Certificate::CurrentUser\My
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Thumbprint                                Subject
</span></span><span style=display:flex><span>----------                                -------
</span></span><span style=display:flex><span>E2EBB991E3849E32E934D8465FAE42787D34C9ED  CN=testClientTLS, OU=Your Unit, O=Your Organization, L=Austin, S=Texas, C=US
</span></span></code></pre></div><p>By default, the private key is marked as non-exportable. A user or an application cannot export the private key from the certificate store. They can only access the private key via Windows APIs. Using a non-exportable private key is the recommended security approach. You can use the <code>-Exportable</code> parameter if you need to export the private key.</p><h2 id=verifying-imported-certificates-and-keys>Verifying imported certificates and keys</h2><p>As an extra step, we can verify that the certificates and keys exist in the Windows certificate store. We can use the <code>certlm</code> Local Machine Certificate Manager GUI, <code>certmgr</code> User Certificate Manager GUI, or the <code>Get-ChildItem</code> powershell command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Get-ChildItem -Path Cert<span style=color:#960050;background-color:#1e0010>:</span>\LocalMachine\Root |
</span></span><span style=display:flex><span>        Where-Object{$_.Subject <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#39;testServerCA&#39;</span>} |
</span></span><span style=display:flex><span>        Test-Certificate -Policy SSL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Get-ChildItem -Path Cert<span style=color:#960050;background-color:#1e0010>:</span>\CurrentUser\My | Where-Object{$_.Subject <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#39;testClientTLS&#39;</span>}
</span></span></code></pre></div><h2 id=running-the-mtls-server>Running the mTLS server</h2><p>We will use the same <code>docker-compose.yml</code> file from the <a class=link href=../mtls-hello-world>mTLS Hello World</a> article. The <code>docker-compose.yml</code> file starts two nginx servers:</p><ul><li>https://&lt;your_host>:8888 for TLS</li><li>https://&lt;your_host>:8889 for mTLS</li></ul><p>We can run Docker on WSL (Windows Subsystem for Linux) or another machine. We will run it on a different machine, so we need to copy the <code>certs</code> directory to the machine running Docker. When running the server on a different machine, we must update the <code>C:\Windows\System32\drivers\etc\hosts</code> file to point to the other machine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>10.0.0.5 myhost
</span></span></code></pre></div><h2 id=connecting-to-the-tls-and-mtls-servers-with-clients>Connecting to the TLS and mTLS servers with clients</h2><p>Because we added the server CA to the root certificate store, we can now access the TLS server without any additional flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-WebRequest -Uri https<span style=color:#960050;background-color:#1e0010>:</span>//myhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8888</span>/hello-world.txt
</span></span></code></pre></div><p>Result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>StatusCode        : 200
</span></span><span style=display:flex><span>StatusDescription : OK
</span></span><span style=display:flex><span>Content           : TLS Hello World!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RawContent        : HTTP/1.1 200 OK
</span></span><span style=display:flex><span>                    Connection: keep-alive
</span></span><span style=display:flex><span>                    Accept-Ranges: bytes
</span></span><span style=display:flex><span>                    Content-Length: 17
</span></span><span style=display:flex><span>                    Content-Type: text/plain
</span></span><span style=display:flex><span>                    Date: Sun, 03 Mar 2024 17:28:29 GMT
</span></span><span style=display:flex><span>                    ETag: &#34;65b29c19-11&#34;
</span></span><span style=display:flex><span>                    Last-Modified: Thu, 25 Jan 2024 1...
</span></span><span style=display:flex><span>Forms             : {}
</span></span><span style=display:flex><span>Headers           : {[Connection, keep-alive], [Accept-Ranges, bytes], [Content-Length, 17], [Content-Type, text/plain]...}
</span></span><span style=display:flex><span>Images            : {}
</span></span><span style=display:flex><span>InputFields       : {}
</span></span><span style=display:flex><span>Links             : {}
</span></span><span style=display:flex><span>ParsedHtml        : System.__ComObject
</span></span><span style=display:flex><span>RawContentLength  : 17
</span></span></code></pre></div><p>However, we cannot access the mTLS server directly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-WebRequest -Uri https<span style=color:#960050;background-color:#1e0010>:</span>//myhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8889</span>/hello-world.txt
</span></span></code></pre></div><p>The client attempted the TLS handshake, but the server rejected the connection because the client did not provide a certificate. Result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Invoke-WebRequest : 400 Bad Request
</span></span><span style=display:flex><span>No required SSL certificate was sent
</span></span><span style=display:flex><span>nginx/1.25.3
</span></span><span style=display:flex><span>At line:1 char:1
</span></span><span style=display:flex><span>+ Invoke-WebRequest -Uri https://myhost:8889/hello-world.txt
</span></span><span style=display:flex><span>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span style=display:flex><span>    + CategoryInfo          : InvalidOperation: (System.Net.HttpWebRequest:HttpWebRequest) [Invoke-WebRequest], WebException
</span></span><span style=display:flex><span>    + FullyQualifiedErrorId : WebCmdletWebResponseException,Microsoft.PowerShell.Commands.InvokeWebRequestCommand
</span></span></code></pre></div><p>We can, however, provide the client certificate thumbprint to access the mTLS server. We saw the thumbprint of the client certificate earlier when we imported it into the Windows certificate store.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Invoke-WebRequest -Uri https<span style=color:#960050;background-color:#1e0010>:</span>//myhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8889</span>/hello-world.txt -CertificateThumbprint E2EBB991E3849E32E934D8465FAE42787D34C9ED
</span></span></code></pre></div><p>Result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>StatusCode        : 200
</span></span><span style=display:flex><span>StatusDescription : OK
</span></span><span style=display:flex><span>Content           : mTLS Hello World!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RawContent        : HTTP/1.1 200 OK
</span></span><span style=display:flex><span>                    Connection: keep-alive
</span></span><span style=display:flex><span>                    Accept-Ranges: bytes
</span></span><span style=display:flex><span>                    Content-Length: 18
</span></span><span style=display:flex><span>                    Content-Type: text/plain
</span></span><span style=display:flex><span>                    Date: Sun, 03 Mar 2024 17:31:55 GMT
</span></span><span style=display:flex><span>                    ETag: &#34;65b29c19-12&#34;
</span></span><span style=display:flex><span>                    Last-Modified: Thu, 25 Jan 2024 1...
</span></span><span style=display:flex><span>Forms             : {}
</span></span><span style=display:flex><span>Headers           : {[Connection, keep-alive], [Accept-Ranges, bytes], [Content-Length, 18], [Content-Type, text/plain]...}
</span></span><span style=display:flex><span>Images            : {}
</span></span><span style=display:flex><span>InputFields       : {}
</span></span><span style=display:flex><span>Links             : {}
</span></span><span style=display:flex><span>ParsedHtml        : System.__ComObject
</span></span><span style=display:flex><span>RawContentLength  : 18
</span></span></code></pre></div><p>Edge browser can access the mTLS server. We can verify this by opening the following URL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>https://myhost:8889/hello-world.txt
</span></span></code></pre></div><p>We see the following popup:</p><figure><img src=/posts/mtls-with-windows/mtls-edge.png alt="Edge mTLS popup"><figcaption><p>Edge mTLS popup</p></figcaption></figure><p>We can click <strong>OK</strong> to connect to the mTLS server. Future connections will not show the popup and will automatically use the client certificate.</p><p><strong>Note:</strong> Here is a helpful link that may resolve issues trying to use mTLS client certificates on Windows 10: <a class=link href=https://superuser.com/questions/1181163/unable-to-use-client-certificates-in-chrome-or-ie-on-windows-10 target=_blank rel=noopener>https://superuser.com/questions/1181163/unable-to-use-client-certificates-in-chrome-or-ie-on-windows-10</a></p><h2 id=example-code-on-github>Example code on Github</h2><p>The example code is available on GitHub at <a class=link href=https://github.com/getvictor/mtls/tree/master/mtls-with-windows target=_blank rel=noopener>https://github.com/getvictor/mtls/tree/master/mtls-with-windows</a></p><h2 id=creating-our-own-windows-mtls-client>Creating our own Windows mTLS client</h2><p>In the following article, we will <a class=link href=../mtls-go-client-windows-certificate-store>create a custom Windows mTLS client using the Windows certificate store</a>.</p><h2 id=mtls-with-windows-certificate-store-video>mTLS with Windows certificate store video</h2><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/GuubP7vir1g allowfullscreen title="YouTube Video"></iframe></div></section><footer class=article-footer><section class=article-tags><a href=/tags/tls/>TLS</a>
<a href=/tags/windows/>Windows</a>
<a href=/tags/cybersecurity/>CyberSecurity</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/mtls-go-client-using-apple-keychain/><div class=article-image><img src=/posts/mtls-go-client-using-apple-keychain/_hud963623ee8c982f67106bb07901b6549_184805_77ec0983a7dc46caee56f0d61234d48c.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client using macOS keychain" data-hash="md5-S+hViX6nuIl+AnowxEnSVg=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client using macOS keychain</h2></div></a></article><article class=has-image><a href=/posts/mtls-go-custom-signer/><div class=article-image><img src=/posts/mtls-go-custom-signer/signer.4d60e63c2cfbb31978535b2b67059f38_hua0a59126f5575ffea6eb49be2c13e061_265380_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client with custom certificate signer" data-hash="md5-TWDmPCz7sxl4U1srZwWfOA=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client with custom certificate signer</h2></div></a></article><article class=has-image><a href=/posts/mtls-go-client/><div class=article-image><img src=/posts/mtls-go-client/go-client.d367a206fbe9c06685ee92f65e0026b9_hufc23aaa179917ecd1cfc752f8bc6da43_88506_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client" data-hash="md5-02eiBvvpwGaF7pL2XgAmuQ=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client</h2></div></a></article><article class=has-image><a href=/posts/mtls-with-apple-keychain/><div class=article-image><img src=/posts/mtls-with-apple-keychain/mtls-safari.41faaa695a87796a08c7ccbf7e315636_hued6427f760192911581582be7803ed21_87861_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with macOS keychain" data-hash="md5-QfqqaVqHeWoIx8y/fjFWNg=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) with macOS keychain</h2></div></a></article><article class=has-image><a href=/posts/mtls-hello-world/><div class=article-image><img src=/posts/mtls-hello-world/mtls-handshake.3ef0a7e0079622040ec097fae24fb360_hu50cf7289da7ab96edbbfa70ffae00656_51351_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS intro and hands-on example" data-hash="md5-PvCn4AeWIgQOwJf64k+zYA=="></div><div class=article-details><h2 class=article-title>Mutual TLS intro and hands-on example</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>