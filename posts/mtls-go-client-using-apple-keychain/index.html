<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="How to build an mTLS Go client that uses Apple's macOS keychain"><title>Mutual TLS (mTLS) Go client using macOS keychain</title>
<link rel=canonical href=https://victoronsoftware.com/posts/mtls-go-client-using-apple-keychain/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="Mutual TLS (mTLS) Go client using macOS keychain"><meta property='og:description' content="How to build an mTLS Go client that uses Apple's macOS keychain"><meta property='og:url' content='https://victoronsoftware.com/posts/mtls-go-client-using-apple-keychain/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='TLS'><meta property='article:tag' content='Golang'><meta property='article:tag' content='macOS'><meta property='article:tag' content='CyberSecurity'><meta property='article:published_time' content='2024-02-22T00:00:00+00:00'><meta property='article:modified_time' content='2024-02-22T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain.png'><meta name=twitter:title content="Mutual TLS (mTLS) Go client using macOS keychain"><meta name=twitter:description content="How to build an mTLS Go client that uses Apple's macOS keychain"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain.png'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu02a35fbedf562a954847f1a0edade347_219789_300x0_resize_box_3.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=menu-social><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202" xmlns="http://www.w3.org/2000/svg"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/mtls-go-client-using-apple-keychain/><img src=/posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain_hud963623ee8c982f67106bb07901b6549_184805_800x0_resize_box_3.png srcset="/posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain_hud963623ee8c982f67106bb07901b6549_184805_800x0_resize_box_3.png 800w, /posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain_hud963623ee8c982f67106bb07901b6549_184805_1600x0_resize_box_3.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client using macOS keychain"></a></div><div class=article-details><header class=article-category><a href=/categories/mtls/>mTLS</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/mtls-go-client-using-apple-keychain/>Mutual TLS (mTLS) Go client using macOS keychain</a></h2><h3 class=article-subtitle>How to build an mTLS Go client that uses Apple's macOS keychain</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Feb 22, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p><em>This article is part of a series on <a class=link href=/categories/mtls>mTLS</a>. Check out the previous articles:</em></p><ul><li><a class=link href=../mtls-hello-world>mTLS Hello World</a></li><li><a class=link href=../mtls-with-apple-keychain>mTLS with macOS keychain</a></li><li><a class=link href=../mtls-go-client>mTLS Go client</a></li><li><a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a></li></ul><h2 id=why-use-macos-keychain><a href=#why-use-macos-keychain>#</a>
Why use macOS keychain?</h2><p>In the <a class=link href=../mtls-go-client>mTLS Go client</a> article, we built a simple Go client that uses mTLS. Our client used Go standard library methods and loaded the client certificate and private key from the filesystem. However, keeping the private key on the filesystem is insecure and not recommended. We aim to build an mTLS client fully integrated with the operating system&rsquo;s keystore.</p><p>The macOS keychain is a secure storage system for passwords and other confidential information. It is used by many Apple applications, such as Safari, Mail, and iCloud, to store the user&rsquo;s passwords and additional sensitive information.</p><h2 id=building-a-custom-tlscertificate-for-macos-keychain><a href=#building-a-custom-tlscertificate-for-macos-keychain>#</a>
Building a custom tls.Certificate for macOS keychain</h2><p>This work builds on the <a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a> article. We will use the <code>CustomSigner</code> from that article to build a custom <code>tls.Certificate</code> that uses the macOS keychain.</p><p>However, before the application uses the <code>Public</code> and <code>Sign</code> methods of the <code>CustomSigner,</code> we need to retrieve the certificate from the keychain using Apple&rsquo;s API.</p><h3 id=retrieving-certificate-from-macos-keychain-with-cgo><a href=#retrieving-certificate-from-macos-keychain-with-cgo>#</a>
Retrieving certificate from macOS keychain with CGO</h3><p>We will use CGO to call the macOS keychain API to retrieve the client certificate. To set up CGO, we include the following code above our imports:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>   #cgo LDFLAGS: -framework CoreFoundation -framework Security
</span></span></span><span style=display:flex><span><span style=color:#75715e>   #include &lt;CoreFoundation/CoreFoundation.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>   #include &lt;Security/Security.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;C&#34;</span>
</span></span></code></pre></div><p>To find the identities from the keychain, we use <a class=link href=https://developer.apple.com/documentation/security/1398306-secitemcopymatching target=_blank rel=noopener>SecItemCopyMatching</a>. An identity is a certificate and its associated private key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>identitySearch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryCreateMutable</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFAllocatorDefault</span>, <span style=color:#a6e22e>maxCertificatesNum</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFTypeDictionaryKeyCallBacks</span>,
</span></span><span style=display:flex><span>     <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFTypeDictionaryValueCallBacks</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>identitySearch</span>)))
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>commonName</span> = <span style=color:#e6db74>&#34;testClientTLS&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>commonNameCFString</span> = <span style=color:#a6e22e>stringToCFString</span>(<span style=color:#a6e22e>commonName</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>commonNameCFString</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryAddValue</span>(<span style=color:#a6e22e>identitySearch</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecClass</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecClassIdentity</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryAddValue</span>(<span style=color:#a6e22e>identitySearch</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecAttrCanSign</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFBooleanTrue</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryAddValue</span>(<span style=color:#a6e22e>identitySearch</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecMatchSubjectWholeString</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>commonNameCFString</span>))
</span></span><span style=display:flex><span><span style=color:#75715e>// To filter by issuers, we must provide a CFDataRef array of DER-encoded ASN.1 items.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// C.CFDictionaryAddValue(identitySearch, unsafe.Pointer(C.kSecMatchIssuers), unsafe.Pointer(issuerCFArray))
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryAddValue</span>(<span style=color:#a6e22e>identitySearch</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecReturnRef</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFBooleanTrue</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryAddValue</span>(<span style=color:#a6e22e>identitySearch</span>, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecMatchLimit</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecMatchLimitAll</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>identityMatches</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecItemCopyMatching</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDictionaryRef</span>(<span style=color:#a6e22e>identitySearch</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>identityMatches</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>errSecSuccess</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to find client certificate: %v&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>identityMatches</span>)
</span></span></code></pre></div><p>In our example, we find the identities by a common name, which we hardcode for demonstration purposes. We can filter by the certificate issuer, as shown in the commented-out code. Filtering by issuer requires an array of DER-encoded ASN.1 items, which can be created from the <code>tls.CertificateRequestInfo</code> object. Another approach to finding the proper certificate is to retrieve all the keychain certificates and filter them in Go code.</p><h3 id=converting-the-apple-identity-to-a-go-x509certificate><a href=#converting-the-apple-identity-to-a-go-x509certificate>#</a>
Converting the Apple identity to a Go <code>x509.Certificate</code></h3><p>After we retrieve the array of identities from the keychain, we convert them to Go <code>x509.Certificate</code> objects and pick the first one that is not expired.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>foundCert</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>Certificate</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>foundIdentity</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityRef</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>identityMatchesArrayRef</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFArrayRef</span>(<span style=color:#a6e22e>identityMatches</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>numIdentities</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFArrayGetCount</span>(<span style=color:#a6e22e>identityMatchesArrayRef</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Found %d identities\n&#34;</span>, <span style=color:#a6e22e>numIdentities</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>numIdentities</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identityMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFArrayGetValueAtIndex</span>(<span style=color:#a6e22e>identityMatchesArrayRef</span>, <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFIndex</span>(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x509Cert</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>identityRefToCert</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityRef</span>(<span style=color:#a6e22e>identityMatch</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make sure certificate is not expired
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>x509Cert</span>.<span style=color:#a6e22e>NotAfter</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundCert</span> = <span style=color:#a6e22e>x509Cert</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundIdentity</span> = <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityRef</span>(<span style=color:#a6e22e>identityMatch</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Found certificate from issuer %s with public key type %T\n&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>x509Cert</span>.<span style=color:#a6e22e>Issuer</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>x509Cert</span>.<span style=color:#a6e22e>PublicKey</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>identityRefToCert</code> function converts the <code>SecIdentityRef</code> to a Go <code>x509.Certificate</code> object. It exports the certificate to PEM format using <a class=link href=https://developer.apple.com/documentation/security/1394828-secitemexport target=_blank rel=noopener>SecItemExport</a> and then parses the PEM to get the <code>x509.Certificate</code> object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>identityRefToCert</span>(<span style=color:#a6e22e>identityRef</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityRef</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>Certificate</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Convert the identity to a certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>certificateRef</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecCertificateRef</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityCopyCertificate</span>(<span style=color:#a6e22e>identityRef</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>certificateRef</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get certificate from identity: %v&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>certificateRef</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Export the certificate to PEM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// SecItemExport: https://developer.apple.com/documentation/security/1394828-secitemexport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pemDataRef</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataRef</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecItemExport</span>(
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>certificateRef</span>), <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecFormatPEMSequence</span>, <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecItemPemArmour</span>, <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>           <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pemDataRef</span>,
</span></span><span style=display:flex><span>    ); <span style=color:#a6e22e>status</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to export certificate to PEM: %v&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>pemDataRef</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>certPEM</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>GoBytes</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataGetBytePtr</span>(<span style=color:#a6e22e>pemDataRef</span>)),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>C</span>.int(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataGetLength</span>(<span style=color:#a6e22e>pemDataRef</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>x509Cert</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>Certificate</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>block</span>, <span style=color:#a6e22e>rest</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pem</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#a6e22e>certPEM</span>); <span style=color:#a6e22e>block</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span>; <span style=color:#a6e22e>block</span>, <span style=color:#a6e22e>rest</span> = <span style=color:#a6e22e>pem</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#a6e22e>rest</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>block</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;CERTIFICATE&#34;</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>x509Cert</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>ParseCertificate</span>(<span style=color:#a6e22e>block</span>.<span style=color:#a6e22e>Bytes</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error parsing client certificate: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x509Cert</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=retrieve-the-private-key-reference-from-the-keychain><a href=#retrieve-the-private-key-reference-from-the-keychain>#</a>
Retrieve the private key reference from the keychain</h3><p>At this point, we also retrieve the private key reference from the keychain. We will use the private key reference to sign the <code>CertificateVerify</code> message during the TLS handshake. The reference does not contain the private key. When importing private keys to the keychain, they should be marked as non-exportable so that no one can retrieve the private key cleartext from the keychain.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>privateKey</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecKeyRef</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityCopyPrivateKey</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecIdentityRef</span>(<span style=color:#a6e22e>foundIdentity</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>privateKey</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to copy private key ref from identity: %v&#34;</span>, <span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=building-the-custom-tlscertificate><a href=#building-the-custom-tlscertificate>#</a>
Building the custom <code>tls.Certificate</code></h3><p>Finally, we put together the custom <code>tls.Certificate</code> using the <code>x509.Certificate</code> and the private key reference.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>customSigner</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CustomSigner</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x509Cert</span>:   <span style=color:#a6e22e>foundCert</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>privateKey</span>: <span style=color:#a6e22e>privateKey</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>certificate</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Certificate</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Certificate</span>:                  [][]<span style=color:#66d9ef>byte</span>{<span style=color:#a6e22e>foundCert</span>.<span style=color:#a6e22e>Raw</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrivateKey</span>:                   <span style=color:#a6e22e>customSigner</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SupportedSignatureAlgorithms</span>: []<span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>SignatureScheme</span>{<span style=color:#a6e22e>supportedAlgorithm</span>},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our example only supports the <code>tls.PSSWithSHA256</code> signature algorithm to keep the code simple. Adding additional algorithm support is easy since it only requires passing the right parameter to the <code>SecKeyCreateSignature</code> function, which we will review next.</p><h2 id=signing-the-mtls-digest-with-apples-keychain><a href=#signing-the-mtls-digest-with-apples-keychain>#</a>
Signing the mTLS digest with Apple&rsquo;s keychain</h2><p>As discussed in the previous <a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a> article, we need to sign the <code>CertificateVerify</code> message during the TLS handshake. We will use the <code>CustomSigner</code> to sign the digest, which implements the <code>crypto.Signer</code> interface as defined in the Go standard library&rsquo;s <code>crypto</code> package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CustomSigner</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x509Cert</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>Certificate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>privateKey</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecKeyRef</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>k</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CustomSigner</span>) <span style=color:#a6e22e>Public</span>() <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>PublicKey</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;crypto.Signer.Public\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>x509Cert</span>.<span style=color:#a6e22e>PublicKey</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>k</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CustomSigner</span>) <span style=color:#a6e22e>Sign</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>, <span style=color:#a6e22e>digest</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>SignerOpts</span>) (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>signature</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;crypto.Signer.Sign with key type %T, opts type %T, hash %s\n&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>Public</span>(), <span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>HashFunc</span>().<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Convert the digest to a CFDataRef
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>digestCFData</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataCreate</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kCFAllocatorDefault</span>,
</span></span><span style=display:flex><span>        (<span style=color:#f92672>*</span><span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>UInt8</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>digest</span>[<span style=color:#ae81ff>0</span>])), <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFIndex</span>(len(<span style=color:#a6e22e>digest</span>)))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>digestCFData</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SecKeyAlgorithm: https://developer.apple.com/documentation/security/seckeyalgorithm
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// SecKeyCreateSignature: https://developer.apple.com/documentation/security/1643916-seckeycreatesignature
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cfErrorRef</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFErrorRef</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>signCFData</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>SecKeyCreateSignature</span>(
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>privateKey</span>, <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>kSecKeyAlgorithmRSASignatureDigestPSSSHA256</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataRef</span>(<span style=color:#a6e22e>digestCFData</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cfErrorRef</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfErrorRef</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to sign data: %v&#34;</span>, <span style=color:#a6e22e>cfErrorRef</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFRelease</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFTypeRef</span>(<span style=color:#a6e22e>signCFData</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Convert CFDataRef to Go byte slice
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>GoBytes</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataGetBytePtr</span>(<span style=color:#a6e22e>signCFData</span>)),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>C</span>.int(<span style=color:#a6e22e>C</span>.<span style=color:#a6e22e>CFDataGetLength</span>(<span style=color:#a6e22e>signCFData</span>))), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We use the <a class=link href=https://developer.apple.com/documentation/security/1643916-seckeycreatesignature target=_blank rel=noopener>SecKeyCreateSignature</a> function to sign the digest. The function takes the private key reference, the algorithm, the digest, and a pointer to a <code>CFErrorRef.</code> The function returns a CFDataRef, which we convert to a Go byte slice. Additional algorithms can be supported by passing the proper parameter to the <code>SecKeyCreateSignature</code> function.</p><h2 id=putting-it-all-together><a href=#putting-it-all-together>#</a>
Putting it all together</h2><p>With the above code, we can create our new Go mTLS client that uses the macOS keychain.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlPath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;url&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;URL to make request to&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>urlPath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;URL to make request to is required&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Transport</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>TLSClientConfig</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>GetClientCertificate</span>: <span style=color:#a6e22e>signer</span>.<span style=color:#a6e22e>GetClientCertificate</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>MinVersion</span>:           <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>VersionTLS13</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>MaxVersion</span>:           <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>VersionTLS13</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>       },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make a GET request to the URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rsp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>urlPath</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;error making get request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rsp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read the response body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rspBytes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>rsp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;error reading response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Print the response body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s\n&#34;</span>, string(<span style=color:#a6e22e>rspBytes</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We limit the scope of this example to TLS 1.3</p><h2 id=build-the-mtls-client><a href=#build-the-mtls-client>#</a>
Build the mTLS client</h2><p>With <code>go build client-signer.go</code>, we generate the <code>client-signer</code> executable.</p><h2 id=setting-up-the-environment><a href=#setting-up-the-environment>#</a>
Setting up the environment</h2><p>The next step is to use the macOS keychain to store the client certificate and private key. We will use the same certificates and keys script from the <a class=link href=../mtls-with-apple-keychain>mTLS with macOS keychain</a> article. If you still need to generate the certificates and keys, please follow the instructions in that article.</p><p>We must also import the generated certificates and keys into the macOS keychain.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Import the server CA</span>
</span></span><span style=display:flex><span>security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/server-ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client CA so that client TLS certificates can be verified</span>
</span></span><span style=display:flex><span>security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/client-ca.crt
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client TLS certificate and key</span>
</span></span><span style=display:flex><span>security import certs/client.crt -k /Library/Keychains/System.keychain
</span></span><span style=display:flex><span>security import certs/client.key -k /Library/Keychains/System.keychain -x -T $PWD/client-signer -T /usr/bin/curl -T /Applications/Safari.app -T <span style=color:#e6db74>&#39;/Applications/Google Chrome.app&#39;</span>
</span></span></code></pre></div><p>We specify our application <code>$PWD/client-signer</code> as one of the trusted applications that can access the private key. If we do not select the trusted application, we will get a security pop-up whenever our app tries to access the private key.</p><p>Finally, as in the <a class=link href=../mtls-hello-world>mTLS Hello World</a> article, we will use <code>docker compose up</code> to start two nginx servers:</p><ul><li>https://localhost:8888 for TLS</li><li>https://localhost:8889 for mTLS</li></ul><h2 id=running-the-go-mtls-client-using-the-macos-keychain><a href=#running-the-go-mtls-client-using-the-macos-keychain>#</a>
Running the Go mTLS client using the macOS keychain</h2><p>We can now run our mTLS client without pointing to certificate and key files. Hitting the ordinary TLS server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./client-signer --url https://localhost:8888/hello-world.txt
</span></span></code></pre></div><p>Returns the expected:</p><pre tabindex=0><code>TLS Hello World!
</code></pre><p>While hitting the mTLS server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>./client-signer --url https://localhost:8889/hello-world.txt
</span></span></code></pre></div><p>Returns a more detailed message, including the print statements in our custom code:</p><pre tabindex=0><code>Server requested certificate
Found 1 identities
Found certificate from issuer CN=testClientCA,OU=Your Unit,O=Your Organization,L=Austin,ST=Texas,C=US with public key type *rsa.PublicKey
crypto.Signer.Public
crypto.Signer.Public
crypto.Signer.Sign with key type *rsa.PublicKey, opts type *rsa.PSSOptions, hash SHA-256
mTLS Hello World!
</code></pre><h2 id=using-certificate-and-key-from-the-windows-certificate-store><a href=#using-certificate-and-key-from-the-windows-certificate-store>#</a>
Using certificate and key from the Windows certificate store</h2><p>The following article will explore <a class=link href=../mtls-with-windows>using the Windows certificate store to hold the mTLS client certificate and private key</a>.</p><h2 id=example-code-on-github><a href=#example-code-on-github>#</a>
Example code on GitHub</h2><p>The example code is available on GitHub at <a class=link href=https://github.com/getvictor/mtls/tree/master/mtls-go-apple-keychain target=_blank rel=noopener>https://github.com/getvictor/mtls/tree/master/mtls-go-apple-keychain</a></p><h2 id=mtls-go-client-using-macos-keychain-video><a href=#mtls-go-client-using-macos-keychain-video>#</a>
mTLS Go client using macOS keychain video</h2><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/iYWPrL4sR5U allowfullscreen title="YouTube Video"></iframe></div></section><footer class=article-footer><section class=article-tags><a href=/tags/tls/>TLS</a>
<a href=/tags/golang/>Golang</a>
<a href=/tags/macos/>macOS</a>
<a href=/tags/cybersecurity/>CyberSecurity</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/mtls-go-custom-signer/><div class=article-image><img src=/posts/mtls-go-custom-signer/signer.4d60e63c2cfbb31978535b2b67059f38_hua0a59126f5575ffea6eb49be2c13e061_265380_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client with custom certificate signer" data-hash="md5-TWDmPCz7sxl4U1srZwWfOA=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client with custom certificate signer</h2></div></a></article><article class=has-image><a href=/posts/mtls-go-client/><div class=article-image><img src=/posts/mtls-go-client/go-client.d367a206fbe9c06685ee92f65e0026b9_hufc23aaa179917ecd1cfc752f8bc6da43_88506_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client" data-hash="md5-02eiBvvpwGaF7pL2XgAmuQ=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client</h2></div></a></article><article class=has-image><a href=/posts/mtls-with-apple-keychain/><div class=article-image><img src=/posts/mtls-with-apple-keychain/mtls-safari.41faaa695a87796a08c7ccbf7e315636_hued6427f760192911581582be7803ed21_87861_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with macOS keychain" data-hash="md5-QfqqaVqHeWoIx8y/fjFWNg=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) with macOS keychain</h2></div></a></article><article><a href=/posts/inspecting-keychain-files-on-macos/><div class=article-details><h2 class=article-title>Inspecting keychain files on macOS</h2></div></a></article><article><a href=/posts/catch-missed-authorization-checks-during-software-development/><div class=article-details><h2 class=article-title>Catch missed authorization checks during software development</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>