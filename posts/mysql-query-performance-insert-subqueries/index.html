<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Real world example of fixing a slow MySQL query doing an INSERT with subqueries"><title>Optimize MySQL query performance: INSERT with subqueries</title>
<link rel=canonical href=https://victoronsoftware.com/posts/mysql-query-performance-insert-subqueries/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Optimize MySQL query performance: INSERT with subqueries"><meta property='og:description' content="Real world example of fixing a slow MySQL query doing an INSERT with subqueries"><meta property='og:url' content='https://victoronsoftware.com/posts/mysql-query-performance-insert-subqueries/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='SQL Developer'><meta property='article:tag' content='MySQL'><meta property='article:tag' content='SQL Performance'><meta property='article:published_time' content='2024-05-06T00:00:00+00:00'><meta property='article:modified_time' content='2024-05-06T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/mysql-query-performance-insert-subqueries/INSERT%20with%20subqueries.png'><meta name=twitter:title content="Optimize MySQL query performance: INSERT with subqueries"><meta name=twitter:description content="Real world example of fixing a slow MySQL query doing an INSERT with subqueries"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/mysql-query-performance-insert-subqueries/INSERT%20with%20subqueries.png'><script async src="https://www.googletagmanager.com/gtag/js?id=G-1XV381YSQ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1XV381YSQ8")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7557696702933755770.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=menu-social><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/tools/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Software tools</span></a></li><li><a href=/page/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/mysql-query-performance-insert-subqueries/><img src=/posts/mysql-query-performance-insert-subqueries/INSERT%20with%20subqueries_hu4169579447165479852.png srcset="/posts/mysql-query-performance-insert-subqueries/INSERT%20with%20subqueries_hu4169579447165479852.png 800w, /posts/mysql-query-performance-insert-subqueries/INSERT%20with%20subqueries_hu8319039196945899104.png 1600w" width=800 height=419 loading=lazy alt="Featured image of post Optimize MySQL query performance: INSERT with subqueries"></a></div><div class=article-details><header class=article-category><a href=/categories/database-administration/>Database Administration</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/mysql-query-performance-insert-subqueries/>Optimize MySQL query performance: INSERT with subqueries</a></h2><h3 class=article-subtitle>Real world example of fixing a slow MySQL query doing an INSERT with subqueries</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 06, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h2 id=introduction><a href=#introduction class=header-anchor></a>Introduction</h2><p>We recently encountered a performance issue in production. Once an hour, we saw a spike in average DB lock time, along with occasional deadlocks and server errors. We identified the problematic query using <a class=link href=https://aws.amazon.com/rds/ target=_blank rel=noopener>Amazon RDS</a> logs. It was an <code>INSERT</code> statement with subqueries.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> policy_stats (policy_id, inherited_team_id, passing_host_count, failing_host_count)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    p.id,
</span></span><span style=display:flex><span>    t.id <span style=color:#66d9ef>AS</span> inherited_team_id,
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> policy_membership pm
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> hosts h <span style=color:#66d9ef>ON</span> pm.host_id <span style=color:#f92672>=</span> h.id
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> pm.policy_id <span style=color:#f92672>=</span> p.id <span style=color:#66d9ef>AND</span> pm.passes <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>AND</span> h.team_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>AS</span> passing_host_count,
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> policy_membership pm
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> hosts h <span style=color:#66d9ef>ON</span> pm.host_id <span style=color:#f92672>=</span> h.id
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> pm.policy_id <span style=color:#f92672>=</span> p.id <span style=color:#66d9ef>AND</span> pm.passes <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>AND</span> h.team_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>AS</span> failing_host_count
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> policies p
</span></span><span style=display:flex><span><span style=color:#66d9ef>CROSS</span> <span style=color:#66d9ef>JOIN</span> teams t
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> p.team_id <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> p.id, t.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> DUPLICATE <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>UPDATE</span>
</span></span><span style=display:flex><span>    updated_at <span style=color:#f92672>=</span> NOW(),
</span></span><span style=display:flex><span>    passing_host_count <span style=color:#f92672>=</span> <span style=color:#66d9ef>VALUES</span>(passing_host_count),
</span></span><span style=display:flex><span>    failing_host_count <span style=color:#f92672>=</span> <span style=color:#66d9ef>VALUES</span>(failing_host_count);
</span></span></code></pre></div><p>This statement calculated passing/failing results and inserted them into a <code>policy_stats</code> summary table. Unfortunately, this query took over 30 seconds to execute. During this time, it locked the important <code>policy_membership</code> table, preventing other threads from writing to it.</p><h2 id=reproducing-slow-sql-queries><a href=#reproducing-slow-sql-queries class=header-anchor></a>Reproducing slow SQL queries</h2><p>Since we saw the issue in production, we needed to reproduce it in a test environment. We created a similar schema and loaded it with data. We used a Go script to populate the tables with dummy data: <a class=link href=https://github.com/getvictor/mysql/blob/main/insert-with-subqueries-perf/main.go target=_blank rel=noopener>https://github.com/getvictor/mysql/blob/main/insert-with-subqueries-perf/main.go</a>.</p><p>Initially, we used ten policies and ten teams with 10,000 hosts each, resulting in 100 inserted rows with the above query. However, the performance was only three to six seconds. Then, we increased the number of policies to 50, resulting in 500 inserted rows. The performance dropped to 30 to 60 seconds.</p><p>The above data made it clear that this query needed to be more scalable. As the <code>GROUP BY p.id, t.id</code> clause demonstrates, performance exponentially degrades with the number of policies and teams.</p><h2 id=debugging-slow-sql-queries><a href=#debugging-slow-sql-queries class=header-anchor></a>Debugging slow SQL queries</h2><p>MySQL has powerful tools called <a class=link href=https://dev.mysql.com/doc/refman/8.0/en/explain.html target=_blank rel=noopener>EXPLAIN</a> and <code>EXPLAIN ANALYSE</code>. These tools show how MySQL executes a query and help identify performance bottlenecks. We ran <code>EXPLAIN ANALYSE</code> on the problematic query and viewed the results as a tree and a diagram.</p><p><figure><img src=/posts/mysql-query-performance-insert-subqueries/mysql-explain-tree.png alt="MySQL EXPLAIN result in TREE format"><figcaption><h4>MySQL EXPLAIN result in TREE format</h4></figcaption></figure><br><figure><img src=/posts/mysql-query-performance-insert-subqueries/mysql-explain-diagram.png alt="MySQL EXPLAIN result as a diagram"><figcaption><h4>MySQL EXPLAIN result as a diagram</h4></figcaption></figure></p><p>Although the <code>EXPLAIN</code> output was complex, it was clear that the <code>SELECT</code> subqueries were executing too many times.</p><h2 id=fixing-insert-with-subqueries-performance><a href=#fixing-insert-with-subqueries-performance class=header-anchor></a>Fixing INSERT with subqueries performance</h2><p>The first step was to separate the <code>INSERT</code> from the <code>SELECT</code>. The top <code>SELECT</code> subquery took most of the time. But, more importantly, the <code>SELECT</code> does not block other threads from updating the <code>policy_membership</code> table.</p><p>However, the single standalone <code>SELECT</code> subquery was still slow. In addition, memory usage could be high for many teams and policies.</p><p>We decided to process one policy row at a time. This reduced the time to complete an individual <code>SELECT</code> query to less than two seconds and limited the memory usage. We did not use a transaction to minimize locks. Not utilizing a transaction meant that the <code>INSERT</code> could fail if a parallel process deleted the policy. Also, the <code>INSERT</code> could overwrite a clearing of the <code>policy_stats</code> row. These drawbacks were acceptable, as they were rare cases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    p.id <span style=color:#66d9ef>as</span> policy_id,
</span></span><span style=display:flex><span>    t.id <span style=color:#66d9ef>AS</span> inherited_team_id,
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> policy_membership pm 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> hosts h <span style=color:#66d9ef>ON</span> pm.host_id <span style=color:#f92672>=</span> h.id 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> pm.policy_id <span style=color:#f92672>=</span> p.id <span style=color:#66d9ef>AND</span> pm.passes <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>AND</span> h.team_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>AS</span> passing_host_count,
</span></span><span style=display:flex><span>    (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>FROM</span> policy_membership pm 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> hosts h <span style=color:#66d9ef>ON</span> pm.host_id <span style=color:#f92672>=</span> h.id 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>WHERE</span> pm.policy_id <span style=color:#f92672>=</span> p.id <span style=color:#66d9ef>AND</span> pm.passes <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span> <span style=color:#66d9ef>AND</span> h.team_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>AS</span> failing_host_count
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> policies p
</span></span><span style=display:flex><span><span style=color:#66d9ef>CROSS</span> <span style=color:#66d9ef>JOIN</span> teams t
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> p.team_id <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>AND</span> p.id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> t.id, p.id;
</span></span></code></pre></div><p>After each <code>SELECT</code>, we inserted the results into the <code>policy_stats</code> table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> policy_stats (policy_id, inherited_team_id, passing_host_count, failing_host_count)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>VALUES</span> (<span style=color:#f92672>?</span>, <span style=color:#f92672>?</span>, <span style=color:#f92672>?</span>, <span style=color:#f92672>?</span>), ...
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> DUPLICATE <span style=color:#66d9ef>KEY</span> <span style=color:#66d9ef>UPDATE</span>
</span></span><span style=display:flex><span>    updated_at <span style=color:#f92672>=</span> NOW(),
</span></span><span style=display:flex><span>    passing_host_count <span style=color:#f92672>=</span> <span style=color:#66d9ef>VALUES</span>(passing_host_count),
</span></span><span style=display:flex><span>    failing_host_count <span style=color:#f92672>=</span> <span style=color:#66d9ef>VALUES</span>(failing_host_count);
</span></span></code></pre></div><h2 id=further-reading-about-mysql><a href=#further-reading-about-mysql class=header-anchor></a>Further reading about MySQL</h2><ul><li><a class=link href=../mysql-upsert-deadlock/>MySQL deadlock on UPDATE/INSERT upsert pattern</a></li><li><a class=link href=../mysql-master-slave-replication/>Scaling DB performance using master slave replication</a></li><li><a class=link href=../unicode-and-emoji-gotchas/>Fully supporting Unicode and emojis in your app</a></li><li><a class=link href=../sql-prepared-statements-are-broken-when-scaling-applications/>SQL prepared statements are broken when scaling applications</a></li></ul><h2 id=mysql-code-to-populate-db-on-github><a href=#mysql-code-to-populate-db-on-github class=header-anchor></a>MySQL code to populate DB on GitHub</h2><p>The code to populate our test DB is available on GitHub at: <a class=link href=https://github.com/getvictor/mysql/tree/main/insert-with-subqueries-perf target=_blank rel=noopener>https://github.com/getvictor/mysql/tree/main/insert-with-subqueries-perf</a></p><h2 id=mysql-query-performance-insert-with-subqueries-video><a href=#mysql-query-performance-insert-with-subqueries-video class=header-anchor></a>MySQL query performance: INSERT with subqueries video</h2><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/9vulV3W-bp8 allowfullscreen title="YouTube Video"></iframe></div><p><em>Note:</em> If you want to comment on this article, please do so on the YouTube video.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/sql-developer/>SQL Developer</a>
<a href=/tags/mysql/>MySQL</a>
<a href=/tags/sql-performance/>SQL Performance</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/mysql-upsert-deadlock/><div class=article-image><img src=/posts/mysql-upsert-deadlock/MySQL%20deadlock.65122d6e99ece24b1e1751637f018a80_hu553165977798494993.png width=250 height=150 loading=lazy alt="Featured image of post MySQL deadlock on UPDATE/INSERT upsert pattern" data-hash="md5-ZRItbpns4kseF1FjfwGKgA=="></div><div class=article-details><h2 class=article-title>MySQL deadlock on UPDATE/INSERT upsert pattern</h2></div></a></article><article class=has-image><a href=/posts/sql-prepared-statements-are-broken-when-scaling-applications/><div class=article-image><img src=/posts/sql-prepared-statements-are-broken-when-scaling-applications/cover.eafd31b48e2454f1eec208dbae83a4f6_hu13700412915599388388.png width=250 height=150 loading=lazy alt="Featured image of post SQL prepared statements are broken when scaling applications" data-hash="md5-6v0xtI4kVPHuwgjbroOk9g=="></div><div class=article-details><h2 class=article-title>SQL prepared statements are broken when scaling applications</h2></div></a></article><article class=has-image><a href=/posts/unicode-and-emoji-gotchas/><div class=article-image><img src=/posts/unicode-and-emoji-gotchas/unicode-emoji.eb9b662f2aff344a37b3e21005ad1a14_hu6841443478200449850.png width=250 height=150 loading=lazy alt="Featured image of post Fully supporting Unicode and emojis in your app" data-hash="md5-65tmLyr/NEo3s+IQBa0aFA=="></div><div class=article-details><h2 class=article-title>Fully supporting Unicode and emojis in your app</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>