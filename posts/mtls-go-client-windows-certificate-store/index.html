<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="How to build an mTLS Go client that uses the Windows certificate store"><title>Mutual TLS (mTLS) Go client using Windows certificate store</title><link rel=canonical href=https://victoronsoftware.com/posts/mtls-go-client-windows-certificate-store/><link rel=stylesheet href=/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Mutual TLS (mTLS) Go client using Windows certificate store"><meta property='og:description' content="How to build an mTLS Go client that uses the Windows certificate store"><meta property='og:url' content='https://victoronsoftware.com/posts/mtls-go-client-windows-certificate-store/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='mTLS'><meta property='article:tag' content='TLS'><meta property='article:tag' content='Golang'><meta property='article:tag' content='Windows'><meta property='article:tag' content='Application Security'><meta property='article:published_time' content='2024-03-20T00:00:00+00:00'><meta property='article:modified_time' content='2024-03-20T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/mtls-go-client-windows-certificate-store/mtls-go-windows.png'><meta name=twitter:title content="Mutual TLS (mTLS) Go client using Windows certificate store"><meta name=twitter:description content="How to build an mTLS Go client that uses the Windows certificate store"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/mtls-go-client-windows-certificate-store/mtls-go-windows.png'><script async src="https://www.googletagmanager.com/gtag/js?id=G-1XV381YSQ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1XV381YSQ8")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7557696702933755770.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=menu-social><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/tools/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Software tools</span></a></li><li><a href=/page/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/mtls-go-client-windows-certificate-store/><img src=/posts/mtls-go-client-windows-certificate-store/mtls-go-windows_hu4646462682395603939.png srcset="/posts/mtls-go-client-windows-certificate-store/mtls-go-windows_hu4646462682395603939.png 800w, /posts/mtls-go-client-windows-certificate-store/mtls-go-windows_hu8855377067504158814.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client using Windows certificate store"></a></div><div class=article-details><header class=article-category><a href=/categories/security/>Security
</a><a href=/categories/software-development/>Software Development</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/mtls-go-client-windows-certificate-store/>Mutual TLS (mTLS) Go client using Windows certificate store</a></h2><h3 class=article-subtitle>How to build an mTLS Go client that uses the Windows certificate store</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 20, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p><em>This article is part of a series on <a class=link href=../mtls>mTLS</a>. Check out the previous articles:</em></p><ul><li><a class=link href=../mtls-hello-world>mTLS Hello World</a></li><li><a class=link href=../mtls-with-apple-keychain>mTLS with macOS keychain</a></li><li><a class=link href=../mtls-go-client>mTLS Go client</a></li><li><a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a></li><li><a class=link href=../mtls-go-client-using-apple-keychain>mTLS Go client using macOS keychain</a></li><li><a class=link href=../mtls-with-windows>mTLS with Windows certificate store</a></li></ul><h2 id=why-use-the-windows-certificate-store><a href=#why-use-the-windows-certificate-store class=header-anchor></a>Why use the Windows certificate store?</h2><p>Keeping the mTLS client private key on the filesystem is insecure and not recommended. In the <a class=link href=../mtls-go-client-using-apple-keychain>mTLS Go client using macOS keychain</a>, we demonstrated achieving greater mTLS security with macOS keychain. In this article, we reach a similar level of protection with the Windows certificate store.</p><p>The Windows certificate store is a secure location where certificates and keys can be stored. Many applications, such as Edge and Powershell, use it. The Windows certificate store is an excellent place to store mTLS client certificates and keys.</p><h2 id=building-a-custom-tlscertificate-for-the-windows-certificate-store><a href=#building-a-custom-tlscertificate-for-the-windows-certificate-store class=header-anchor></a>Building a custom tls.Certificate for the Windows certificate store</h2><p>This work builds on the <a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a> article. We will use the <code>CustomSigner</code> from that article to build a custom <code>tls.Certificate</code> that uses the Windows certificate store.</p><p>However, before the application uses the <code>Public</code> and <code>Sign</code> methods of the <code>CustomSigner,</code> we must retrieve the client certificate using Windows APIs.</p><h3 id=retrieving-mtls-client-certificate-from-windows-certificate-store-using-go><a href=#retrieving-mtls-client-certificate-from-windows-certificate-store-using-go class=header-anchor></a>Retrieving mTLS client certificate from Windows certificate store using Go</h3><p>We will use the <a class=link href=https://pkg.go.dev/golang.org/x/sys/windows target=_blank rel=noopener>golang.org/x/sys/windows</a> package to access the Windows APIs. We use the <code>windows</code> package to call the <a class=link href=https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-certopenstore target=_blank rel=noopener>CertOpenStore</a>, <a class=link href=https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-certfindcertificateinstore target=_blank rel=noopener>CertFindCertificateInStore</a>, and <a class=link href=https://learn.microsoft.com/en-us/windows/win32/api/wincrypt/nf-wincrypt-cryptacquirecertificateprivatekey target=_blank rel=noopener>CryptAcquireCertificatePrivateKey</a> functions from the <code>crypt32</code> DLL (dynamic link library).</p><p>First, we open the <code>MY</code> store, which is the personal store for the current user. This store contains our client mTLS certificate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Open the certificate store
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>storePtr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>UTF16PtrFromString</span>(<span style=color:#a6e22e>windowsStoreName</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>store</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CertOpenStore</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CERT_STORE_PROV_SYSTEM</span>,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    uintptr(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CERT_SYSTEM_STORE_CURRENT_USER</span>,
</span></span><span style=display:flex><span>    uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>storePtr</span>)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next, we find the certificate by the common name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Find the certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pPrevCertContext</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CertContext</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>certContext</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CertContext</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>commonNamePtr</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>UTF16PtrFromString</span>(<span style=color:#a6e22e>commonName</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>certContext</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CertFindCertificateInStore</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>store</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>X509_ASN_ENCODING</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CERT_FIND_SUBJECT_STR</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>commonNamePtr</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pPrevCertContext</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We can extract the certificate chain and further filter the certificate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// we want here.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=converting-the-windows-certificate-to-a-go-x509certificate><a href=#converting-the-windows-certificate-to-a-go-x509certificate class=header-anchor></a>Converting the Windows certificate to a Go <code>x509.Certificate</code></h3><p>After retrieving the certificate from the Windows certificate store, we convert it to a Go <code>x509.Certificate</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Copy the certificate data so that we have our own copy outside the windows context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>encodedCert</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>certContext</span>.<span style=color:#a6e22e>EncodedCert</span>, <span style=color:#a6e22e>certContext</span>.<span style=color:#a6e22e>Length</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>buf</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Clone</span>(<span style=color:#a6e22e>encodedCert</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>foundCert</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>ParseCertificate</span>(<span style=color:#a6e22e>buf</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=building-the-custom-tlscertificate><a href=#building-the-custom-tlscertificate class=header-anchor></a>Building the custom <code>tls.Certificate</code></h3><p>Finally, we put together the custom <code>tls.Certificate</code> using the <code>x509.Certificate</code>. We hold on to the <code>certContext</code> pointer to get the private key later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>customSigner</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CustomSigner</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>:              <span style=color:#a6e22e>store</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windowsCertContext</span>: <span style=color:#a6e22e>certContext</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>customSigner</span>.<span style=color:#a6e22e>x509Cert</span> = <span style=color:#a6e22e>foundCert</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>certificate</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Certificate</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Certificate</span>:                  [][]<span style=color:#66d9ef>byte</span>{<span style=color:#a6e22e>foundCert</span>.<span style=color:#a6e22e>Raw</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrivateKey</span>:                   <span style=color:#a6e22e>customSigner</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SupportedSignatureAlgorithms</span>: []<span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>SignatureScheme</span>{<span style=color:#a6e22e>supportedAlgorithm</span>},
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Our example only supports the <code>tls.PSSWithSHA256</code> signature algorithm to keep the code simple.</p><h2 id=signing-the-mtls-digest-with-the-windows-certificate-store><a href=#signing-the-mtls-digest-with-the-windows-certificate-store class=header-anchor></a>Signing the mTLS digest with the Windows certificate store</h2><p>As discussed in the previous <a class=link href=../mtls-go-custom-signer>mTLS Go client with custom certificate signer</a> article, we must sign the <code>CertificateVerify</code> message during the TLS handshake. We will use the <code>CustomSigner</code> to sign the digest, which implements the <code>crypto.Signer</code> interface as defined in the Go standard library&rsquo;s <code>crypto</code> package.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// CustomSigner is a crypto.Signer that uses the client certificate and key to sign
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CustomSigner</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>              <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>Handle</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windowsCertContext</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CertContext</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>x509Cert</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>x509</span>.<span style=color:#a6e22e>Certificate</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>k</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CustomSigner</span>) <span style=color:#a6e22e>Public</span>() <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>PublicKey</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;crypto.Signer.Public\n&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>x509Cert</span>.<span style=color:#a6e22e>PublicKey</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>k</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CustomSigner</span>) <span style=color:#a6e22e>Sign</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>, <span style=color:#a6e22e>digest</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>SignerOpts</span>
</span></span><span style=display:flex><span>    ) (<span style=color:#a6e22e>signature</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><h4 id=retrieve-the-private-key-reference-from-the-windows-certificate-store><a href=#retrieve-the-private-key-reference-from-the-windows-certificate-store class=header-anchor></a>Retrieve the private key reference from the Windows certificate store</h4><p>We retrieve the private key reference from the Windows certificate store using the <code>CryptAcquireCertificatePrivateKey</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Get private key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>privateKey</span>                  <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>Handle</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pdwKeySpec</span>                  <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pfCallerFreeProvOrNCryptKey</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CryptAcquireCertificatePrivateKey</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>k</span>.<span style=color:#a6e22e>windowsCertContext</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CRYPT_ACQUIRE_CACHE_FLAG</span>|<span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CRYPT_ACQUIRE_SILENT_FLAG</span>|
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>CRYPT_ACQUIRE_ONLY_NCRYPT_KEY_FLAG</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>privateKey</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pdwKeySpec</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pfCallerFreeProvOrNCryptKey</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=signing-the-mtls-digest><a href=#signing-the-mtls-digest class=header-anchor></a>Signing the mTLS digest</h4><p>We will use the <a class=link href=https://learn.microsoft.com/en-us/windows/win32/api/ncrypt/nf-ncrypt-ncryptsignhash target=_blank rel=noopener>NCryptSignHash</a> function from <code>ncrypt.dll</code> to sign the digest.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nCrypt</span>         = <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>MustLoadDLL</span>(<span style=color:#e6db74>&#34;ncrypt.dll&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nCryptSignHash</span> = <span style=color:#a6e22e>nCrypt</span>.<span style=color:#a6e22e>MustFindProc</span>(<span style=color:#e6db74>&#34;NCryptSignHash&#34;</span>)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>But before we do that, we must create a <code>BCRYPT_PSS_PADDING_INFO</code> structure for our supported RSA-PSS algorithm.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>flags</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nCryptSilentFlag</span> | <span style=color:#a6e22e>bCryptPadPss</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pPaddingInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getRsaPssPadding</span>(<span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Where <code>getRsaPssPadding</code> is a helper function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getRsaPssPadding</span>(<span style=color:#a6e22e>opts</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>SignerOpts</span>) (<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pssOpts</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>opts</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>rsa</span>.<span style=color:#a6e22e>PSSOptions</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>pssOpts</span>.<span style=color:#a6e22e>Hash</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>SHA256</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported hash function %s&#34;</span>, <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>HashFunc</span>().<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pssOpts</span>.<span style=color:#a6e22e>SaltLength</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rsa</span>.<span style=color:#a6e22e>PSSSaltLengthEqualsHash</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unsupported salt length %d&#34;</span>, <span style=color:#a6e22e>pssOpts</span>.<span style=color:#a6e22e>SaltLength</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sha256</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>windows</span>.<span style=color:#a6e22e>UTF16PtrFromString</span>(<span style=color:#e6db74>&#34;SHA256&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create BCRYPT_PSS_PADDING_INFO structure:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// typedef struct _BCRYPT_PSS_PADDING_INFO {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//     LPCWSTR pszAlgId;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//     ULONG   cbSalt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// } BCRYPT_PSS_PADDING_INFO;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(
</span></span><span style=display:flex><span>       <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pszAlgId</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>uint16</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cbSalt</span>   <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>       }{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pszAlgId</span>: <span style=color:#a6e22e>sha256</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cbSalt</span>:   uint32(<span style=color:#a6e22e>pssOpts</span>.<span style=color:#a6e22e>HashFunc</span>().<span style=color:#a6e22e>Size</span>()),
</span></span><span style=display:flex><span>       },
</span></span><span style=display:flex><span>    ), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, we sign the digest using the <code>NCryptSignHash</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>    <span style=color:#75715e>// Sign the digest
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// The first call to NCryptSignHash retrieves the size of the signature
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uint32</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nCryptSignHash</span>.<span style=color:#a6e22e>Call</span>(
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>privateKey</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>pPaddingInfo</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>digest</span>[<span style=color:#ae81ff>0</span>])),
</span></span><span style=display:flex><span>       uintptr(len(<span style=color:#a6e22e>digest</span>)),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>size</span>)),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>flags</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;NCryptSignHash: failed to get signature length: %#x&#34;</span>, <span style=color:#a6e22e>success</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The second call to NCryptSignHash retrieves the signature
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>signature</span> = make([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>nCryptSignHash</span>.<span style=color:#a6e22e>Call</span>(
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>privateKey</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>pPaddingInfo</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>digest</span>[<span style=color:#ae81ff>0</span>])),
</span></span><span style=display:flex><span>       uintptr(len(<span style=color:#a6e22e>digest</span>)),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>signature</span>[<span style=color:#ae81ff>0</span>])),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>size</span>),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>size</span>)),
</span></span><span style=display:flex><span>       uintptr(<span style=color:#a6e22e>flags</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;NCryptSignHash: failed to generate signature: %#x&#34;</span>, <span style=color:#a6e22e>success</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>signature</span>, <span style=color:#66d9ef>nil</span>
</span></span></code></pre></div><h2 id=putting-it-all-together><a href=#putting-it-all-together class=header-anchor></a>Putting it all together</h2><p>With the above code, we can create our new Go mTLS client that uses the Windows certificate store.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>urlPath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;url&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;URL to make request to&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>flag</span>.<span style=color:#a6e22e>Parse</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>urlPath</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;URL to make request to is required&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Transport</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>TLSClientConfig</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>GetClientCertificate</span>: <span style=color:#a6e22e>signer</span>.<span style=color:#a6e22e>GetClientCertificate</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>MinVersion</span>:           <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>VersionTLS13</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>MaxVersion</span>:           <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>VersionTLS13</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>       },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make a GET request to the URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rsp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>urlPath</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;error making get request: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rsp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Read the response body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>rspBytes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>rsp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;error reading response: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Print the response body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s\n&#34;</span>, string(<span style=color:#a6e22e>rspBytes</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We limit the scope of this example to TLS 1.3</p><h2 id=setting-up-the-environment><a href=#setting-up-the-environment class=header-anchor></a>Setting up the environment</h2><p>The next step is to use the Windows certificate store to store the client certificate and private key. We will use the certificates and keys scripts from the previous <a class=link href=../mtls-with-windows>mTLS with Windows certificate store</a> article. If you still need to generate the certificates and keys, please follow the instructions in that article.</p><p>Finally, as in the <a class=link href=../mtls-with-windows>mTLS with Windows certificate store</a> article, we start two nginx servers:</p><ul><li>https://&lt;your_host>:8888 for TLS</li><li>https://&lt;your_host>:8889 for mTLS</li></ul><h2 id=running-the-go-mtls-client-using-the-windows-certificate-store><a href=#running-the-go-mtls-client-using-the-windows-certificate-store class=header-anchor></a>Running the Go mTLS client using the Windows certificate store</h2><p>We can run our mTLS client without pointing to certificate/key files and retrieving everything from the Windows certificate store. Hitting the ordinary TLS server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>go run .\client-signer.go --url https<span style=color:#960050;background-color:#1e0010>:</span>//myhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8888</span>/hello-world.txt
</span></span></code></pre></div><p>Returns the expected:</p><pre tabindex=0><code>TLS Hello World!
</code></pre><p>While hitting the mTLS server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>go run .\client-signer.go --url https<span style=color:#960050;background-color:#1e0010>:</span>//myhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8889</span>/hello-world.txt
</span></span></code></pre></div><p>Returns a more detailed message, including the print statements in our custom code:</p><pre tabindex=0><code>Server requested certificate
Found certificate with common name testClientTLS
crypto.Signer.Public
crypto.Signer.Public
crypto.Signer.Sign with key type *rsa.PublicKey, opts type *rsa.PSSOptions, hash SHA-256
mTLS Hello World!
</code></pre><h2 id=example-code-on-github><a href=#example-code-on-github class=header-anchor></a>Example code on GitHub</h2><p>The example code is available on GitHub at <a class=link href=https://github.com/getvictor/mtls/tree/master/mtls-go-windows target=_blank rel=noopener>https://github.com/getvictor/mtls/tree/master/mtls-go-windows</a></p><h2 id=mtls-go-client-using-windows-certificate-store-video><a href=#mtls-go-client-using-windows-certificate-store-video class=header-anchor></a>mTLS Go client using Windows certificate store video</h2><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/L4uk43i3kyY allowfullscreen title="YouTube Video"></iframe></div><p><em>Note:</em> If you want to comment on this article, please do so on the YouTube video.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/mtls/>mTLS</a>
<a href=/tags/tls/>TLS</a>
<a href=/tags/golang/>Golang</a>
<a href=/tags/windows/>Windows</a>
<a href=/tags/application-security/>Application Security</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/mtls-go-client-using-apple-keychain/><div class=article-image><img src=/posts/mtls-go-client-using-apple-keychain/mtls-go-apple-keychain.4be855897ea7b8897e027a30c449d256_hu9663222902861578666.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client using macOS keychain" data-hash="md5-S+hViX6nuIl+AnowxEnSVg=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client using macOS keychain</h2></div></a></article><article class=has-image><a href=/posts/mtls-go-custom-signer/><div class=article-image><img src=/posts/mtls-go-custom-signer/signer.4d60e63c2cfbb31978535b2b67059f38_hu10458632819968436544.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client with custom certificate signer" data-hash="md5-TWDmPCz7sxl4U1srZwWfOA=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client with custom certificate signer</h2></div></a></article><article class=has-image><a href=/posts/mtls-go-client/><div class=article-image><img src=/posts/mtls-go-client/go-client.d367a206fbe9c06685ee92f65e0026b9_hu18190656592406348482.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) Go client" data-hash="md5-02eiBvvpwGaF7pL2XgAmuQ=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) Go client</h2></div></a></article><article class=has-image><a href=/posts/mtls-with-windows/><div class=article-image><img src=/posts/mtls-with-windows/mtls-edge.148b2d13beb1a2231542bf5950875c93_hu18240766985919795390.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with Windows certificate store" data-hash="md5-FIstE76xoiMVQr9ZUIdckw=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) with Windows certificate store</h2></div></a></article><article class=has-image><a href=/posts/mtls-with-apple-keychain/><div class=article-image><img src=/posts/mtls-with-apple-keychain/mtls-safari.41faaa695a87796a08c7ccbf7e315636_hu12186587663214958407.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with macOS keychain" data-hash="md5-QfqqaVqHeWoIx8y/fjFWNg=="></div><div class=article-details><h2 class=article-title>Mutual TLS (mTLS) with macOS keychain</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>