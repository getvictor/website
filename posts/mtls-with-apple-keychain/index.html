<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="How to configure mTLS using Apple's macOS keychain"><title>Mutual TLS (mTLS) with macOS keychain</title>
<link rel=canonical href=https://victoronsoftware.com/posts/mtls-with-apple-keychain/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="Mutual TLS (mTLS) with macOS keychain"><meta property='og:description' content="How to configure mTLS using Apple's macOS keychain"><meta property='og:url' content='https://victoronsoftware.com/posts/mtls-with-apple-keychain/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='mTLS'><meta property='article:tag' content='TLS'><meta property='article:tag' content='macOS'><meta property='article:tag' content='Cyber Security'><meta property='article:published_time' content='2024-01-31T00:00:00+00:00'><meta property='article:modified_time' content='2024-01-31T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/mtls-with-apple-keychain/mtls-safari.png'><meta name=twitter:title content="Mutual TLS (mTLS) with macOS keychain"><meta name=twitter:description content="How to configure mTLS using Apple's macOS keychain"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/mtls-with-apple-keychain/mtls-safari.png'><script async src="https://www.googletagmanager.com/gtag/js?id=G-1XV381YSQ8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1XV381YSQ8")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7557696702933755770.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=menu-social><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/tools/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Software tools</span></a></li><li><a href=/page/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/mtls-with-apple-keychain/><img src=/posts/mtls-with-apple-keychain/mtls-safari_hu1441025766753754995.png srcset="/posts/mtls-with-apple-keychain/mtls-safari_hu1441025766753754995.png 800w, /posts/mtls-with-apple-keychain/mtls-safari_hu15950415978265203364.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Mutual TLS (mTLS) with macOS keychain"></a></div><div class=article-details><header class=article-category><a href=/categories/security/>Security</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/posts/mtls-with-apple-keychain/>Mutual TLS (mTLS) with macOS keychain</a></h2><h3 class=article-subtitle>How to configure mTLS using Apple's macOS keychain</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 31, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>7 minute read</time></div></footer></div></header><section class=article-content><p><em>This article is part of a series on <a class=link href=../mtls>mTLS</a>. Check out the previous article: <a class=link href=../mtls-hello-world>mTLS Hello World</a>.</em></p><h2 id=securing-mtls-certificates-and-keys><a href=#securing-mtls-certificates-and-keys class=header-anchor></a>Securing mTLS certificates and keys</h2><p>In the <a class=link href=../mtls-hello-world>mTLS Hello World</a> article, we generated mTLS certificates and keys for the client and the server. We also created two certificate authorities (CAs) and signed the client and server certificates with their respective CAs. We ended up with the following files:</p><ul><li>server CA: <code>certs/server-ca.crt</code></li><li>server CA private key: <code>certs/server-ca.key</code></li><li>TLS certificate for localhost server: <code>certs/server.crt</code></li><li>server TLS certificate private key: <code>certs/server.key</code></li><li>client CA: <code>certs/client-ca.crt</code></li><li>client CA private key: <code>certs/client-ca.key</code></li><li>TLS certificate for client: <code>certs/client.crt</code></li><li>client TLS certificate private key: <code>certs/client.key</code></li></ul><p>In a real-world scenario, we would need to secure these files. The server CA private key and the client CA private key are the most important files to secure. If an attacker gets access to these files, they can create new certificates and impersonate the server or the client. These two files should be secured in a dedicated secure storage.</p><p>The server will need access to the client CA, the server TLS certificate, and the server TLS certificate private key. The server TLS certificate private key is the most important to secure out of these three files.</p><p>The client will need access to the server CA, the client TLS certificate, and the client TLS certificate private key. We can use the macOS keychain to secure these files. In a future article, we will show how to secure these on Windows with certificate stores.</p><h2 id=apples-macos-keychain><a href=#apples-macos-keychain class=header-anchor></a>Apple&rsquo;s macOS keychain</h2><p>As I&rsquo;ve written in <a class=link href=../inspecting-keychain-files-on-macos>inspecting keychain files on macOS</a>, keychains are the macOS&rsquo;s method to track and protect secure information such as passwords, private keys, and certificates.</p><p>The system keychain is located at <code>/Library/Keychains/System.keychain</code>. It contains the root certificates and other certificates. The login keychain is located at <code>/Users/&lt;username>/Library/Keychains/login.keychain-db</code>. It contains the user&rsquo;s certificates and private keys. In this example, we will use the system keychain, which all users on the system can access.</p><h2 id=generating-mtls-certificates-and-keys><a href=#generating-mtls-certificates-and-keys class=header-anchor></a>Generating mTLS certificates and keys</h2><p>We will use the following script to generate the mTLS certificates and keys. It resembles the script from the <a class=link href=../mtls-hello-world>mTLS Hello World</a> article.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># This script generates certificates and keys needed for mTLS.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p certs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Private keys for CAs</span>
</span></span><span style=display:flex><span>openssl genrsa -out certs/server-ca.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>openssl genrsa -out certs/client-ca.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate CA certificates</span>
</span></span><span style=display:flex><span>openssl req -new -x509 -nodes -days <span style=color:#ae81ff>1000</span> -key certs/server-ca.key -out certs/server-ca.crt -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testServerCA&#34;</span>
</span></span><span style=display:flex><span>openssl req -new -x509 -nodes -days <span style=color:#ae81ff>1000</span> -key certs/client-ca.key -out certs/client-ca.crt -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testClientCA&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate a certificate signing request</span>
</span></span><span style=display:flex><span>openssl req -newkey rsa:2048 -nodes -keyout certs/server.key -out certs/server.req -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testServerTLS&#34;</span>
</span></span><span style=display:flex><span>openssl req -newkey rsa:2048 -nodes -keyout certs/client.key -out certs/client.req -subj <span style=color:#e6db74>&#34;/C=US/ST=Texas/L=Austin/O=Your Organization/OU=Your Unit/CN=testClientTLS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Have the CA sign the certificate requests and output the certificates.</span>
</span></span><span style=display:flex><span>openssl x509 -req -in certs/server.req -days <span style=color:#ae81ff>398</span> -CA certs/server-ca.crt -CAkey certs/server-ca.key -set_serial <span style=color:#ae81ff>01</span> -out certs/server.crt -extfile localhost.ext
</span></span><span style=display:flex><span>openssl x509 -req -in certs/client.req -days <span style=color:#ae81ff>398</span> -CA certs/client-ca.crt -CAkey certs/client-ca.key -set_serial <span style=color:#ae81ff>01</span> -out certs/client.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Clean up</span>
</span></span><span style=display:flex><span>rm certs/server.req
</span></span><span style=display:flex><span>rm certs/client.req
</span></span></code></pre></div><p>The maximum validity period for a TLS certificate is 398 days. Apple will reject certificates with a more extended validity period.</p><h2 id=importing-client-mtls-certificates-and-keys-into-the-macos-keychain><a href=#importing-client-mtls-certificates-and-keys-into-the-macos-keychain class=header-anchor></a>Importing client mTLS certificates and keys into the macOS keychain</h2><p>We will import the client mTLS certificates and keys into the macOS keychain using the following script. The script uses the <a class=link href=https://ss64.com/mac/security.html target=_blank rel=noopener>security</a> command line tool. Accessing the system keychain must be run as root (<code>sudo</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># This script imports mTLS certificates and keys into the Apple Keychain.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Import the server CA</span>
</span></span><span style=display:flex><span>security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/server-ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client CA so that client TLS certificates can be verified</span>
</span></span><span style=display:flex><span>security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain certs/client-ca.crt
</span></span><span style=display:flex><span><span style=color:#75715e># Import the client TLS certificate and key</span>
</span></span><span style=display:flex><span>security import certs/client.crt -k /Library/Keychains/System.keychain
</span></span><span style=display:flex><span>security import certs/client.key -k /Library/Keychains/System.keychain -x -T /usr/bin/curl -T /Applications/Safari.app -T <span style=color:#e6db74>&#39;/Applications/Google Chrome.app&#39;</span>
</span></span></code></pre></div><p>The <code>-x</code> option marks the imported key as non-extractable. No application or user can view the private key once it is imported. The private key can only be used indirectly via Apple&rsquo;s APIs.</p><p>The <code>-T</code> option specifies the applications that can access the key. Additional applications may be added later to the access control list.</p><h2 id=verifying-imported-certificates-and-keys><a href=#verifying-imported-certificates-and-keys class=header-anchor></a>Verifying imported certificates and keys</h2><p>As an extra step, we can verify the client and server certificates before using them in an application.</p><p>We can verify the server certificate by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>security verify-cert -c certs/server.crt -p ssl -s localhost -k /Library/Keychains/System.keychain
</span></span></code></pre></div><p>The output should include:</p><pre tabindex=0><code>...certificate verification successful.
</code></pre><p>The Apple keychain automatically combines the certificate and the private key into an identity. We can verify the client identity by running the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>security find-identity -p ssl-client /Library/Keychains/System.keychain
</span></span></code></pre></div><p>The list of identities should include:</p><pre tabindex=0><code>Policy: SSL (client)
  Matching identities
  1) B307B90CCD374080E74F1B15AF602B35A75D8401 &#34;testClientTLS&#34;
     1 identities found

  Valid identities only
  1) B307B90CCD374080E74F1B15AF602B35A75D8401 &#34;testClientTLS&#34;
     1 valid identities found
</code></pre><p>macOS can validate the identity because we also imported the client CA into the system keychain.</p><h2 id=running-the-mtls-server><a href=#running-the-mtls-server class=header-anchor></a>Running the mTLS server</h2><p>As in the <a class=link href=../mtls-hello-world>mTLS Hello World</a> article, we will use <code>docker compose up</code> to start two nginx servers:</p><ul><li>https://localhost:8888 for TLS</li><li>https://localhost:8889 for mTLS</li></ul><h2 id=connecting-to-the-tls-and-mtls-servers-with-clients><a href=#connecting-to-the-tls-and-mtls-servers-with-clients class=header-anchor></a>Connecting to the TLS and mTLS servers with clients</h2><p>Because the server CA was added to the system keychain, curl can now access the TLS server without any additional flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl https://localhost:8888/hello-world.txt
</span></span></code></pre></div><p>However, the built-in curl client cannot access the mTLS server. We use the <code>-v</code> option for additional information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v https://localhost:8889/hello-world.txt
</span></span></code></pre></div><p>The output:</p><pre tabindex=0><code>*   Trying [::1]:8889...
* Connected to localhost (::1) port 8889
* ALPN: curl offers h2,http/1.1
* (304) (OUT), TLS handshake, Client hello (1):
*  CAfile: /etc/ssl/cert.pem
*  CApath: none
* (304) (IN), TLS handshake, Server hello (2):
* (304) (IN), TLS handshake, Unknown (8):
* (304) (IN), TLS handshake, Request CERT (13):
* (304) (IN), TLS handshake, Certificate (11):
* (304) (IN), TLS handshake, CERT verify (15):
* (304) (IN), TLS handshake, Finished (20):
* (304) (OUT), TLS handshake, Certificate (11):
* (304) (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / AEAD-CHACHA20-POLY1305-SHA256
* ALPN: server accepted http/1.1
* Server certificate:
*  subject: C=US; ST=Texas; L=Austin; O=Your Organization; OU=Your Unit; CN=testServerTLS
*  start date: Jan 28 17:08:10 2024 GMT
*  expire date: Mar  1 17:08:10 2025 GMT
*  subjectAltName: host &#34;localhost&#34; matched cert&#39;s &#34;localhost&#34;
*  issuer: C=US; ST=Texas; L=Austin; O=Your Organization; OU=Your Unit; CN=testServerCA
*  SSL certificate verify ok.
* using HTTP/1.1
&gt; GET /hello-world.txt HTTP/1.1
&gt; Host: localhost:8889
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 400 Bad Request
&lt; Server: nginx/1.25.3
&lt; Date: Sun, 28 Jan 2024 18:28:20 GMT
&lt; Content-Type: text/html
&lt; Content-Length: 237
&lt; Connection: close
&lt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;400 No required SSL certificate was sent&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;
&lt;center&gt;No required SSL certificate was sent&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.25.3&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
* Closing connection
</code></pre><p>The client attempted the TLS handshake, but the server rejected the connection because the client did not provide a certificate. Our built-in curl client does not currently support mTLS using the macOS keychain. The client used for this example is:</p><pre tabindex=0><code>curl 8.4.0 (x86_64-apple-darwin23.0) libcurl/8.4.0 (SecureTransport) LibreSSL/3.3.6 zlib/1.2.12 nghttp2/1.55.1
Release-Date: 2023-10-11
Protocols: dict file ftp ftps gopher gophers http https imap imaps ldap ldaps mqtt pop3 pop3s rtsp smb smbs smtp smtps telnet tftp
Features: alt-svc AsynchDNS GSS-API HSTS HTTP2 HTTPS-proxy IPv6 Kerberos Largefile libz MultiSSL NTLM NTLM_WB SPNEGO SSL threadsafe UnixSockets
</code></pre><p>On the other hand, Safari can access the mTLS server. We can verify this by opening the following URL in Safari:</p><pre tabindex=0><code>https://localhost:8889/hello-world.txt
</code></pre><p>We see the following popup:</p><figure><img src=/posts/mtls-with-apple-keychain/mtls-safari.png alt="Safari mTLS popup"><figcaption><p>Safari mTLS popup</p></figcaption></figure><p>We can click <strong>Continue</strong> to connect to the mTLS server. Future connections will not show the popup and will automatically use the client certificate.</p><p>Google Chrome&rsquo;s behavior is similar.</p><p><strong>Note:</strong> If we did not add Safari as an application that can access the client key, Safari would ask for a username and password to connect to the system keychain.</p><h2 id=creating-our-own-mtls-client><a href=#creating-our-own-mtls-client class=header-anchor></a>Creating our own mTLS client</h2><p>In the following article, we will <a class=link href=../mtls-go-client>create our own mTLS client with the Go programming language</a>. This is the first step toward <a class=link href=../mtls-go-client-using-apple-keychain>creating an mTLS client integrated with the macOS keychain</a>.</p><p>Later, we will <a class=link href=../mtls-with-windows>use mTLS with the Windows certificate store</a> and <a class=link href=../mtls-go-client-windows-certificate-store>create an mTLS client integrated with the Windows certificate store</a>.</p><h2 id=further-reading><a href=#further-reading class=header-anchor></a>Further reading</h2><ul><li>Recently, we explained <a class=link href=../macos-launchd-agents-and-daemons/>agents and daemons and plists on macOS</a>.</li><li>We also showed <a class=link href=../script-only-macos-install-package/>how to convert a script into a macOS install package</a>.</li></ul><h2 id=example-code-on-github><a href=#example-code-on-github class=header-anchor></a>Example code on GitHub</h2><p>The example code is available on GitHub at <a class=link href=https://github.com/getvictor/mtls/tree/master/mtls-with-apple-keychain target=_blank rel=noopener>https://github.com/getvictor/mtls/tree/master/mtls-with-apple-keychain</a></p><h2 id=mtls-with-macos-keychain-video><a href=#mtls-with-macos-keychain-video class=header-anchor></a>mTLS with macOS keychain video</h2><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/Y0y6-cCzz8w allowfullscreen title="YouTube Video"></iframe></div><p><em>Note:</em> If you want to comment on this article, please do so on the YouTube video.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/mtls/>mTLS</a>
<a href=/tags/tls/>TLS</a>
<a href=/tags/macos/>macOS</a>
<a href=/tags/cyber-security/>Cyber Security</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/mtls-hello-world/><div class=article-image><img src=/posts/mtls-hello-world/mtls-handshake.3ef0a7e0079622040ec097fae24fb360_hu3203704980808959980.png width=250 height=150 loading=lazy alt="Featured image of post Mutual TLS intro and hands-on example" data-hash="md5-PvCn4AeWIgQOwJf64k+zYA=="></div><div class=article-details><h2 class=article-title>Mutual TLS intro and hands-on example</h2></div></a></article><article><a href=/posts/inspecting-keychain-files-on-macos/><div class=article-details><h2 class=article-title>Inspecting keychain files on macOS</h2></div></a></article><article class=has-image><a href=/posts/understanding-the-intricacies-of-fleet-policies/><div class=article-image><img src=/posts/understanding-the-intricacies-of-fleet-policies/understanding-the-intricacies-of-fleet-policies-main-policies-page-1999x978@2x.64cab4669deb2ae3cfcd074df178d0df_hu745982019498369687.png width=250 height=150 loading=lazy alt="Featured image of post Understanding the intricacies of Fleet policies" data-hash="md5-ZMq0Zp3rKuPPzQdN8XjQ3w=="></div><div class=article-details><h2 class=article-title>Understanding the intricacies of Fleet policies</h2></div></a></article><article class=has-image><a href=/posts/get-current-telemetry-from-your-devices-with-live-queries/><div class=article-image><img src=/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query.b807967d303d64ce866304609285050a_hu18069959350536610369.png width=250 height=150 loading=lazy alt="Featured image of post Get current telemetry from your devices with live queries" data-hash="md5-uAeWfTA9ZM6GYwRgkoUFCg=="></div><div class=article-details><h2 class=article-title>Get current telemetry from your devices with live queries</h2></div></a></article><article class=has-image><a href=/posts/physical-security-meets-cybersecurity-with-matter/><div class=article-image><img src=/posts/physical-security-meets-cybersecurity-with-matter/cover.5453e3320663c069954d9f6ec1a69403_hu13498696599800988544.png width=250 height=150 loading=lazy alt="Featured image of post Physical security meets cybersecurity with Matter" data-hash="md5-VFPjMgZjwGmVTZ9uwaaUAw=="></div><div class=article-details><h2 class=article-title>Physical security meets cybersecurity with Matter</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2025 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>