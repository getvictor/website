<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Query devices with Fleet"><title>Get current telemetry from your devices with live queries</title>
<link rel=canonical href=https://victoronsoftware.com/posts/get-current-telemetry-from-your-devices-with-live-queries/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="Get current telemetry from your devices with live queries"><meta property='og:description' content="Query devices with Fleet"><meta property='og:url' content='https://victoronsoftware.com/posts/get-current-telemetry-from-your-devices-with-live-queries/'><meta property='og:site_name' content='Victor on Software'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='fleet'><meta property='article:tag' content='CyberSecurity'><meta property='article:tag' content='UnderTheHood'><meta property='article:published_time' content='2023-12-29T00:00:00+00:00'><meta property='article:modified_time' content='2023-12-29T00:00:00+00:00'><meta property='og:image' content='https://victoronsoftware.com/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query.png'><meta name=twitter:title content="Get current telemetry from your devices with live queries"><meta name=twitter:description content="Query devices with Fleet"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://victoronsoftware.com/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query.png'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu02a35fbedf562a954847f1a0edade347_219789_300x0_resize_box_3.png width=300 height=297 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Victor on Software</a></h1><h2 class=site-description>Software engineering, security, and related topics</h2></div></header><ol class=menu-social><li><a href=https://fleetdm.com target=_blank title=Fleet rel=me><svg width="58.219mm" height="58.202mm" viewBox="0 0 58.219 58.202" xmlns="http://www.w3.org/2000/svg"><g stroke-width=".26458"><path d="m7.5963 14.823c3.954.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2053 7.1594 7.1594 7.1594z" fill="#63c740"/><path d="m29.075 14.823c3.9539.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2054-7.1594-7.1594-7.1594-3.9541.0-7.1595 3.2053-7.1595 7.1594.0 3.954 3.2054 7.1594 7.1595 7.1594z" fill="#5cabdf"/><path d="m50.552 14.823c3.9542.0 7.1594-3.2053 7.1594-7.1594.0-3.954-3.2052-7.1594-7.1594-7.1594-3.9539.0-7.1594 3.2053-7.1594 7.1594.0 3.954 3.2054 7.1594 7.1594 7.1594z" fill="#d66c7b"/><path d="m7.5963 36.301c3.954.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.954.0-7.1594 3.2054-7.1594 7.1595.0 3.9539 3.2053 7.1594 7.1594 7.1594z" fill="#c98def"/><path d="m29.075 36.301c3.9539.0 7.1594-3.2054 7.1594-7.1594.0-3.9541-3.2054-7.1595-7.1594-7.1595-3.9541.0-7.1595 3.2054-7.1595 7.1595.0 3.9539 3.2054 7.1594 7.1595 7.1594z" fill="#faa669"/><path d="m7.5963 57.779c3.954.0 7.1594-3.2052 7.1594-7.1594.0-3.9539-3.2054-7.1594-7.1594-7.1594-3.954.0-7.1594 3.2054-7.1594 7.1594.0 3.9542 3.2053 7.1594 7.1594 7.1594z" fill="#3aefc4"/></g></svg></a></li><li><a href=https://github.com/getvictor target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/lyuboslavsky/ target=_blank title=LinkedIn rel=me><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentcolor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526.0 1.175.0h13.65C15.474.0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487.0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401m-1.2-8.212c.837.0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822.0-1.359.54-1.359 1.248.0.694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869.0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274.0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54.0 01.016-.025V6.169h-2.4c.03.678.0 7.225.0 7.225h2.4"/></svg></a></li><li><a href=http://www.youtube.com/@VictorOnSoftware target=_blank title=YouTube rel=me><svg height="800" width="800" id="Layer_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 461.001 461.001"><g><path style="fill:#f61c0d" d="M365.257 67.393H95.744C42.866 67.393.0 110.259.0 163.137v134.728c0 52.878 42.866 95.744 95.744 95.744h269.513c52.878.0 95.744-42.866 95.744-95.744V163.137c0-52.878-42.866-95.744-95.744-95.744zM300.506 237.056l-126.06 60.123c-3.359 1.602-7.239-.847-7.239-4.568V168.607c0-3.774 3.982-6.22 7.348-4.514l126.06 63.881C304.363 229.873 304.298 235.248 300.506 237.056z"/></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/page/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/page/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/posts/get-current-telemetry-from-your-devices-with-live-queries/><img src=/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query_hu64e3a4617825ba0468dff8df166d9a56_55465_800x0_resize_box_3.png srcset="/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query_hu64e3a4617825ba0468dff8df166d9a56_55465_800x0_resize_box_3.png 800w, /posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query_hu64e3a4617825ba0468dff8df166d9a56_55465_1600x0_resize_box_3.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Get current telemetry from your devices with live queries"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/get-current-telemetry-from-your-devices-with-live-queries/>Get current telemetry from your devices with live queries</a></h2><h3 class=article-subtitle>Query devices with Fleet</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Dec 29, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><div class=video-wrapper><iframe loading=lazy src=https://www.youtube.com/embed/Jh14hNjW0Uo allowfullscreen title="YouTube Video"></iframe></div><p><a class=link href=https://fleetdm.com/ target=_blank rel=noopener>Fleet</a> is an open-source platform for managing and gathering telemetry from devices such as laptops, desktops, VMs, etc. <a class=link href=https://www.osquery.io/ target=_blank rel=noopener>Osquery</a> agents run on these devices and report to the Fleet server. One of Fleet’s features is the ability to query information from the devices in near real-time, called <em>live queries</em>. This article discusses how live queries work “under the hood.”</p><h2 id=why-a-live-query><a href=#why-a-live-query>#</a>
Why a live query?</h2><p>Live queries enable administrators to ask near real-time questions of all online devices, such as checking the encryption status of SSH keys across endpoints, or obtaining the uptime of each server within their purview. This enables them to promptly identify and address any issues, thereby reducing downtime and maintaining operational efficiency. These tasks, which would be time-consuming and complex if done manually, are streamlined through live queries, offering real-time insights into the status and posture of the entire fleet of devices helping IT and security.</p><h2 id=live-queries-under-the-hood><a href=#live-queries-under-the-hood>#</a>
Live queries under the hood</h2><p>Live queries can be run from the web UI, the command-line interface called <code>fleetctl</code>, or the REST API. The user creates a query and selects which devices will run that query. Here is an example using <code>fleetctl</code> to obtain the operating system name and version for all devices:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fleetctl query --query <span style=color:#e6db74>&#34;select name, version from os_version;&#34;</span> --labels <span style=color:#e6db74>&#34;All Hosts&#34;</span>
</span></span></code></pre></div><p>When a client initiates a live query, the server first creates a <strong>Query Campaign</strong> record in the MySQL database. A Fleet deployment consists of several servers behind a load balancer, so storing the record in the DB makes all servers aware of the new query campaign.</p><figure><img src=/posts/get-current-telemetry-from-your-devices-with-live-queries/Live%20Query.png alt="Query campaign"><figcaption><h4>Query campaign</h4></figcaption></figure><p>As devices called <strong>Hosts</strong> in Fleet check in with the servers, they receive instructions to run a query. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;queries&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;fleet_distributed_query_140&#34;</span>: <span style=color:#e6db74>&#34;SELECT name, version FROM os_version;&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;discovery&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;fleet_distributed_query_140&#34;</span>: <span style=color:#e6db74>&#34;SELECT 1&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then, the osquery agents run the actual query on their host, and write the result back to a Fleet server. As a server receives the result, it publishes it to the common cache using <a class=link href=https://redis.io/docs/interact/pubsub/ target=_blank rel=noopener>Redis Pub/Sub</a>.</p><p>Only the one server communicating with the client subscribes to the results. It processes the data from the cache, keeps track of how many hosts reported back, and communicates results back to the client. The web UI and <code>fleetctl</code> interfaces use a <a class=link href=https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API target=_blank rel=noopener>WebSockets API</a>, and results are reported as they come in. The REST API, on the other hand, only sends a response after all online hosts have reported their query results.</p><h2 id=discover-more><a href=#discover-more>#</a>
Discover more</h2><p>Fleet’s live query feature represents a powerful tool in the arsenal of IT and security administrators. By harnessing the capabilities of live queries, tasks that once required extensive manual effort can now be executed swiftly and efficiently. This real-time querying ability enhances operational efficiency and significantly bolsters security and compliance measures across a range of devices.</p><p>The integration of Fleet with Osquery agents, the flexibility offered by interfaces like the web UI, <code>fleetctl</code>, and the REST API, and the efficient data handling through mechanisms like Redis Pub/Sub and WebSockets API all come together to create a robust, real-time telemetry gathering system. This system is designed to keep you informed about the current state of your device fleet, helping you make informed decisions quickly.</p><p>As you reflect on the capabilities of live queries with Fleet, consider your network environment&rsquo;s unique challenges and needs. <strong>What questions could live queries help you answer about your devices?</strong> Whether it&rsquo;s security audits, performance monitoring, or compliance checks, live queries offer a dynamic solution to address these concerns.</p><p>We encourage you to explore the possibilities and share your thoughts or questions. Perhaps you’re facing a specific query challenge or an innovative use case you’ve discovered. Whatever it may be, the world of live queries is vast and ripe for exploration. Join us in <a class=link href=https://fleetdm.com/support target=_blank rel=noopener>Fleet’s Slack forums</a> to engage with a community of like-minded professionals and deepen your understanding of what live queries can achieve in your environment.</p><p>API Documentation:</p><ul><li><a class=link href=https://fleetdm.com/docs/rest-api/rest-api#run-live-query target=_blank rel=noopener>Run live query with REST API</a></li><li><a class=link href=https://github.com/fleetdm/fleet/blob/6fd06d648601edd89c01e25426e2e35ff2a8a37b/docs/Contributing/API-for-contributors.md#run-live-query target=_blank rel=noopener>Run live query with WebSockets</a></li></ul><p><em>This article originally appeared in <a class=link href=https://fleetdm.com/guides/get-current-telemetry-from-your-devices-with-live-queries target=_blank rel=noopener>Fleet&rsquo;s blog</a>.</em></p></section><footer class=article-footer><section class=article-tags><a href=/tags/fleet/>Fleet</a>
<a href=/tags/cybersecurity/>CyberSecurity</a>
<a href=/tags/underthehood/>UnderTheHood</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/posts/physical-security-meets-cybersecurity-with-matter/><div class=article-image><img src=/posts/physical-security-meets-cybersecurity-with-matter/cover.5453e3320663c069954d9f6ec1a69403_hu240e6838189f9e304ae612d50248a293_9583_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Physical security meets cybersecurity with Matter" data-hash="md5-VFPjMgZjwGmVTZ9uwaaUAw=="></div><div class=article-details><h2 class=article-title>Physical security meets cybersecurity with Matter</h2></div></a></article><article class=has-image><a href=/posts/setting-up-a-virtual-router/><div class=article-image><img src=/posts/setting-up-a-virtual-router/cover.8a38e07f00a8cdcbce7d27092cee5763_hu019a91ef521bad7337cb0514ecaaaefc_16004_250x150_fill_q75_box_smart1.jpeg width=250 height=150 loading=lazy alt="Featured image of post Setting up a virtual router" data-hash="md5-ijjgfwCozcvOfScJLO5XYw=="></div><div class=article-details><h2 class=article-title>Setting up a virtual router</h2></div></a></article><article><a href=/posts/inspecting-keychain-files-on-macos/><div class=article-details><h2 class=article-title>Inspecting keychain files on macOS</h2></div></a></article><article><a href=/posts/catch-missed-authorization-checks-during-software-development/><div class=article-details><h2 class=article-title>Catch missed authorization checks during software development</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 Victor on Software</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>